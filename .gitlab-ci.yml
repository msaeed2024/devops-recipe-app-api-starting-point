image:
  name: docker:24.0

services:
  - docker:24.0-dind

before_script:
  - echo "$DOCKERHUB_TOKEN" | docker login --username $DOCKERHUB_USER --password-stdin

stages:
  - Test and Lint
  - Deploy

Python Checks:
  stage: Test and Lint
  script:
    - docker compose run --rm app sh -c "python manage.py wait_for_db && python manage.py test"
    - docker compose run --rm app sh -c "flake8"
  rules:
    - if: "$CI_COMMIT_BRANCH =~ /^(main|prod)$/"

Terraform Checks:
  stage: Test and Lint
  script:
    - cd infra/
    - docker compose run --rm terraform -chdir=deploy/ init -backend=false
    - docker compose run --rm terraform -chdir=setup/ init -backend=false
    - docker compose run --rm terraform -chdir=setup/ validate
    - docker compose run --rm terraform -chdir=setup/ fmt -check
    - docker compose run --rm terraform -chdir=deploy/ validate
    - docker compose run --rm terraform -chdir=deploy/ fmt -check
  rules:
    - if: "$CI_COMMIT_BRANCH =~ /^(main|prod)$/"

Deploy to AWS:
  image: docker:latest
  stage: Deploy
  services:
    - docker:24.0-dind
  variables:
    DOCKER_DRIVER: overlay2
    AWS_DEFAULT_REGION: us-east-1
  before_script:
    - apk add --no-cache python3 py3-pip
    - pip3 install --upgrade awscli
    - aws --version
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
  script:
    - echo "main:$CI_COMMIT_BRANCH"
    - docker build -t $ECR_REPO_APP:$CI_COMMIT_SHA .
    - docker push $ECR_REPO_APP:$CI_COMMIT_SHA
    - docker build -t $ECR_REPO_PROXY:$CI_COMMIT_SHA proxy/
    - docker push $ECR_REPO_PROXY:$CI_COMMIT_SHA
    - export TF_VAR_ecr_app_image="$ECR_REPO_APP:$CI_COMMIT_SHA"
    - export TF_VAR_ecr_proxy_image="$ECR_REPO_PROXY:$CI_COMMIT_SHA"
    - cd infra/
    - docker compose run --rm terraform -chdir=deploy/ init
    - docker compose run --rm terraform -chdir=deploy/ workspace select -or-create $CI_COMMIT_BRANCH
    - docker compose run --rm terraform -chdir=deploy/ apply -auto-approve
  rules:
    - if: "$CI_COMMIT_BRANCH =~ /^(main|prod)$/"

